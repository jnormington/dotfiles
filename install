#!/bin/bash

DOTFILES_REPO="https://github.com/jnormington/dotfiles"
DOTFILES=$HOME/.dotfiles

# Assume debian based os for now
sudo add-apt-repository ppa:git-core/ppa -y
sudo apt-get update
sudo apt-get install -y git curl wget vim unzip zeal

# Install gnome-shell-tweaks
sudo apt install gnome-shell-extension-dash-to-panel gnome-shell-extension-hide-activities

# Install albert
curl https://build.opensuse.org/projects/home:manuelschneid3r/public_key | sudo apt-key add -

sudo sh -c "echo 'deb http://download.opensuse.org/repositories/home:/manuelschneid3r/xUbuntu_19.10/ /' > /etc/apt/sources.list.d/home:manuelschneid3r.list"
wget -nv https://download.opensuse.org/repositories/home:manuelschneid3r/xUbuntu_19.10/Release.key -O Release.key
sudo apt-key add - < Release.key
sudo apt-get update
sudo apt-get install albert

# Copy albert conf
ALBERT_CONF_DIR=$HOME/.config/albert
mkdir -p $ALBERT_CONF_DIR
cp $DOTFILES/conf/albert.conf $ALBERT_CONF_DIR/

# Remove window decorations from most windows
GTK3_DIR=$HOME/.config/gtk-3.0
mkdir -p $GTK3_DIR
cp $DOTFILES/conf/gtk.css $GTK3_DIR/

# Apply dconf settings for /org/gnome/**/
dconf load /org/gnome/terminal/legacy/ < $DOTFILES/dconf/terminal.dconf
dconf load /org/gnome/desktop/ < $DOTFILES/dconf/desktop.dconf
dconf load /org/gnome/settings-daemon/ < $DOTFILES/dconf/settings_daemon.dconf
dconf load /org/gnome/mutter/ < $DOTFILES/dconf/mutter.dconf
dconf load /org/gnome/shell/ < $DOTFILES/dconf/shell.dconf

# Install Vundle for vim
echo "Install Vundle"
git clone https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim

echo "Install dotfiles"
# Ensure the dotfiles directory exists
git clone $DOTFILES_REPO $DOTFILES

# Move the files/directories in dotfiles into position
for conf in $(ls $DOTFILES)
do
  case "$conf" in
    README.md|install|helpers)
      ;;

    helpers)
      # Let bash_alias will source from dotfiles directly
      ;;

    ssh_config)
      mkdir -p $HOME/.ssh
      [ ! -e $HOME/.ssh/config ] && ln -s $DOTFILES/$conf $HOME/.ssh/config
      echo "Linked: ssh_config"
      ;;

    i3)
      if [[ $(uname) == "Linux" ]]; then
        mkdir -p $HOME/.config/i3
        ln -sf $DOTFILES/i3/config $HOME/.config/i3/config
        echo "Linked: i3 config"
        ln -sf $DOTFILES/i3/i3blocks.conf $HOME/.i3blocks.conf
        echo "Linked: i3 blocks config"
      fi
      ;;

    ftplugin)
      mkdir ~/.vim/after
      ln -sf $DOTFILES/$conf ~/.vim/after/ftplugin
      ;;

    gitconfig)
     sed 's?%HOME_PATH%?'"$HOME"'?' $conf > $HOME/.gitconfig
      ;;

    bashrc)
      mv ~/.bashrc ~/.bashrc.old || true
      echo "Linked: .bashrc"
      ln -sf $DOTFILES/.bashrc ~/.bashrc
      ;;

    *)
      dest=$HOME/.$conf
      echo "Linked: $dest"
      ln -sf $DOTFILES/$conf $dest
  esac
done

echo "Running commands in vim"
vim +PluginInstall +qall +GoInstallBinaries
