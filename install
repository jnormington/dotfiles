#!/bin/bash

DOTFILES_REPO="https://github.com/jnormington/dotfiles"
DOTFILES=$HOME/.dotfiles
HOMEBREW_APPS=(
  Caskroom/cask/disablemonitor
  Caskroom/cask/iterm2
  Caskroom/cask/vagrant
  Caskroom/cask/virtualbox
  Caskroom/cask/virtualbox-extension-pack
  curl
  git
  qpdf
  vim
  wget
  node
  go
)

if [[ $(uname) == "Darwin" ]]; then
  # Install homebrew
  echo "Install homebrew"
  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  # Install all the apps with homebrew
  echo "Installing apps with homebrew"
  brew install ${HOMEBREW_APPS[@]} --force
else
  # Assume debian based os for now
  sudo add-apt-repository ppa:git-core/ppa -y

  # Add spotify sources
  curl -sS https://download.spotify.com/debian/pubkey.gpg | sudo apt-key add -
  echo "deb http://repository.spotify.com stable non-free" | sudo tee /etc/apt/sources.list.d/spotify.list

  sudo apt-get update
  sudo apt-get install -y git curl wget vim unzip pavucontrol zeal spotify-client
fi

# Install Vundle for vim
echo "Install Vundle"
git clone https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim

echo "Install dotfiles"
# Ensure the dotfiles directory exists
git clone $DOTFILES_REPO $DOTFILES

# Move the files/directories in dotfiles into position
for conf in $(ls $DOTFILES)
do
  case "$conf" in
    README.md)
      ;;
    install)
      ;;

    fonts)
      mkdir -p $HOME/.fonts
      cp fonts/* $HOME/.fonts/
      echo "Linked: fonts"
      ;;
    ssh_config)
      mkdir -p $HOME/.ssh
      [ ! -e $HOME/.ssh/config ] && ln -s $DOTFILES/$conf $HOME/.ssh/config
      echo "Linked: ssh_config"
      ;;

    i3config)
      if [[ $(uname) == "Linux" ]]; then
        mkdir -p $HOME/.config/i3
        ln -s $DOTFILES/i3config $HOME/.config/i3/config
        echo "Linked: i3 config"
      fi
      ;;
    i3status)
      if [[ $(uname) == "Linux" ]]; then
        mkdir -p $HOME/.config/i3status
        ln -s $DOTFILES/i3status $HOME/.config/i3status/config
        echo "Linked: i3 status config"
      fi
      ;;

    iterm2)
      if [[ $(uname) == "Darwin" ]]; then
        dest=$HOME/.$conf
        echo "Linked: $dest"
        ln -s $DOTFILES/$conf $dest
      fi
      ;;

    ftplugin)
      mkdir ~/.vim/after/ftplugin
      ln -s $DOTFILES/$conf/* ~/.vim/after/ftplugin/
      ;;

    gitconfig)
     sed 's?%HOME_PATH%?'"$HOME"'?' $conf > $HOME/.gitconfig
      ;;

    helpers)
      # Let bash_alias will source from dotfiles directly
      ;;
    scripts)
      mkdir -p $HOME/.local/bin
      ln -s $DOTFILES/scripts/* $HOME/.local/bin/
      echo "Linked scripts"
      ;;

    *)
      dest=$HOME/.$conf
      echo "Linked: $dest"
      ln -s $DOTFILES/$conf $dest
  esac
done

echo "Running commands in vim"
vim +PluginInstall +qall +GoInstallBinaries
